<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">My Bootstrap Vanilla Blog</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
    
    <style>
        /* --- 1. CUSTOM CSS VARIABLES FOR THEME --- */
        :root {
            /* Light Theme Defaults */
            --bg-color: #f8f9fa; 
            --text-color: #212529; 
            --card-bg: white;
            --card-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            --border-color: #dee2e6;
            --primary-color: #0d6efd; 
            --success-color: #198754;
            --secondary-color: #6c757d;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }

        /* Dark Theme Overrides */
        body[data-theme="dark"] {
            --bg-color: #212529; 
            --text-color: #f8f9fa; 
            --card-bg: #343a40; 
            --card-shadow: 0 0.5rem 1rem rgba(0,0,0,0.3);
            --border-color: #495057;
            --primary-color: #0dcaf0; 
            --success-color: #198754;
            --secondary-color: #495057; 
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }


        /* --- 2. BASE STYLES & FIXES USING VARIABLES --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* FIX: Ensure generic text color applies to all major elements, overriding Bootstrap's specificity */
        body, .card, .form-control, .form-control::placeholder {
            color: var(--text-color) !important;
        }

        /* Custom Styling for the Blog Title */
        #blog-name { 
            cursor: pointer; 
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background 0.2s;
            font-size: 1.5rem; 
            font-weight: 700;
        }
        #blog-name:hover { background: var(--border-color); }
        #blog-name:focus { outline: 2px solid var(--primary-color); background: var(--card-bg); }

        /* FIX: Button Styling - Use !important to ensure theme colors override Bootstrap */
        .btn-primary { 
            background-color: var(--primary-color) !important; 
            border-color: var(--primary-color) !important;
            color: var(--bg-color) !important; 
        }
        body[data-theme="dark"] .btn-primary { 
            color: var(--text-color) !important; 
        }

        .btn-secondary { 
            background-color: var(--secondary-color) !important; 
            border-color: var(--secondary-color) !important;
            color: var(--text-color) !important; 
        }
        .btn-success { 
            background-color: var(--success-color) !important; 
            border-color: var(--success-color) !important; 
        }
        .btn-danger { 
            background-color: var(--danger-color) !important; 
            border-color: var(--danger-color) !important; 
        }
        .btn-warning { 
            background-color: var(--warning-color) !important; 
            border-color: var(--warning-color) !important; 
            color: var(--text-color) !important;
        }
        
        /* Theme Toggle Button Styling */
        #theme-toggle {
            background: var(--card-bg) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-color) !important;
        }
        
        /* Custom Styling for Cards */
        .post-card {
            background: var(--card-bg);
            box-shadow: var(--card-shadow);
            transition: transform 0.2s, background-color 0.3s, box-shadow 0.3s;
        }
        .post-card:hover { transform: translateY(-2px); }
        
        .post-card h3 {
            color: var(--primary-color);
            cursor: pointer;
        }
        .date { 
            color: #888 !important; 
            font-size: 0.85em; 
            display: block; 
            margin-bottom: 10px; 
        }

        /* Form/Text Area Fixes */
        .form-control {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        /* Reader View Content Area */
        #reader-content {
            background: var(--card-bg);
            box-shadow: var(--card-shadow);
        }

        /* NEW: Toolbar Styling */
        #markdown-toolbar {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-bottom: none; /* Merges nicely with the textarea border */
            border-top-left-radius: 0.3rem;
            border-top-right-radius: 0.3rem;
            padding: 0.5rem;
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        #markdown-toolbar .btn {
            font-size: 0.9rem;
            padding: 0.3rem 0.5rem;
            color: var(--text-color) !important;
            background-color: var(--bg-color) !important;
            border-color: var(--border-color) !important;
        }
        #markdown-toolbar .btn:hover {
            background-color: var(--border-color) !important;
        }
        
        /* Utility */
        .hidden { display: none !important; }
    </style>
</head>
<body data-theme="light">

    <div class="container my-4">

        <nav class="navbar navbar-expand-lg border-bottom pb-3 mb-4">
            <div class="container-fluid p-0">
                <h1 id="blog-name" contenteditable="true" onblur="app.setBlogName()">‚úçÔ∏è My Single-File Blog</h1>
                
                <div class="d-flex align-items-center">
                    <button id="theme-toggle" class="btn btn-outline-secondary me-2" onclick="app.toggleTheme()" title="Toggle Light/Dark Mode">üåì</button>
                    <button id="nav-create-btn" class="btn btn-primary" onclick="app.navigate('editor')">
                        <i class="bi bi-plus-lg"></i> + New Post
                    </button>
                </div>
            </div>
        </nav>

        <main>
            <section id="home-view">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <p class="text-muted mb-0 me-3">‚ö†Ô∏è Data stored in this browser (Local Storage).</p>
                    <div>
                        <button class="btn btn-success me-2" onclick="app.importData()">
                            <i class="bi bi-box-arrow-in-down"></i> üì• Import
                        </button>
                        <button class="btn btn-secondary" onclick="app.exportData()">
                            <i class="bi bi-box-arrow-up"></i> üì§ Export
                        </button>
                    </div>
                </div>
                
                <div id="blog-list">
                    </div>
            </section>

            <section id="editor-view" class="hidden">
                <h2 id="editor-heading" class="mb-3">Write New Post</h2>
                <p class="text-muted mb-3">**Markdown formatting is enabled.**</p>
                
                <input type="hidden" id="post-id">
                <input type="text" id="post-title" class="form-control form-control-lg mb-3" placeholder="Enter a catchy title...">
                
                <div id="markdown-toolbar">
                    <button class="btn" onclick="app.formatText('**','**')" title="Bold (Ctrl+B)">**B**</button>
                    <button class="btn" onclick="app.formatText('*','*')" title="Italic (Ctrl+I)">*I*</button>
                    <button class="btn" onclick="app.formatText('# ','')" title="Heading 1">H1</button>
                    <button class="btn" onclick="app.formatText('## ','')" title="Heading 2">H2</button>
                    <button class="btn" onclick="app.formatText('- ','\n')" title="Bullet List">‚Ä¢ List</button>
                    <button class="btn" onclick="app.formatText('1. ','\n')" title="Numbered List">1. List</button>
                    <button class="btn" onclick="app.formatText('[Link Text](','http://example.com)')" title="Link">üîó Link</button>
                    <button class="btn" onclick="app.formatText('`','`')" title="Inline Code">`< >`</button>
                    <button class="btn" onclick="app.formatText('```javascript\n','\n```')" title="Code Block">{' '}</button>
                </div>

                <textarea id="post-content" class="form-control mb-3" rows="15" placeholder="Write your story here..." style="border-top-left-radius: 0; border-top-right-radius: 0; margin-top: 0;"></textarea>
                
                <div class="toolbar d-flex justify-content-start">
                    <button class="btn btn-primary me-2" onclick="app.savePost()">Save Post</button>
                    <button class="btn btn-secondary" onclick="app.cancelEdit()">Cancel</button>
                </div>
            </section>

            <section id="reader-view" class="hidden">
                <div class="toolbar d-flex justify-content-between mb-4">
                    <button class="btn btn-secondary" onclick="app.navigate('home')">
                        <i class="bi bi-arrow-left"></i> ‚Üê Back to Home
                    </button>
                    <div>
                        <button class="btn btn-warning me-2" onclick="app.editCurrentPost()">Edit</button>
                        <button class="btn btn-danger" onclick="app.deleteCurrentPost()">Delete</button>
                    </div>
                </div>
                
                <div id="reader-content" class="p-4 rounded">
                    <h1 id="reader-title" class="mb-1" style="font-size: 2.2rem;"></h1>
                    <small id="reader-date" class="date text-muted d-block mb-3"></small>
                    </div>
            </section>
        </main>

    </div> <script>
        const app = {
            // State: Holds data in memory
            state: {
                posts: [],
                activePostId: null,
                blogName: 'My Bootstrap Vanilla Blog',
                currentTheme: 'light' // Default theme
            },
            
            // --- Initialization ---
            init: () => {
                app.loadData();
                app.loadTheme(); // Load user's saved theme preference
                app.renderBlogName(); 
                app.renderList();
            },

            // --- Theme Functions ---
            loadTheme: () => {
                const savedTheme = localStorage.getItem('themePreference') || 
                                    (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                app.setTheme(savedTheme);
            },
            
            toggleTheme: () => {
                const newTheme = app.state.currentTheme === 'light' ? 'dark' : 'light';
                app.setTheme(newTheme);
                localStorage.setItem('themePreference', newTheme);
            },

            setTheme: (theme) => {
                document.body.setAttribute('data-theme', theme);
                app.state.currentTheme = theme;
                const toggleBtn = document.getElementById('theme-toggle');
                toggleBtn.innerText = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
                toggleBtn.title = theme === 'light' ? 'Switch to Dark Mode' : 'Switch to Light Mode';
            },

            // --- NEW: Text Formatting Function ---
            formatText: (prefix, suffix) => {
                const textarea = document.getElementById('post-content');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const selectedText = textarea.value.substring(start, end);
                
                let newText;

                if (start !== end) {
                    // If text is selected, wrap it
                    newText = prefix + selectedText + suffix;
                } else {
                    // If no text is selected, just insert the format syntax
                    newText = prefix + suffix;
                }

                // Update the textarea value
                textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
                
                // Restore focus and put cursor inside the inserted syntax
                if (start === end) {
                    textarea.focus();
                    textarea.selectionEnd = start + prefix.length;
                }
            },

            // --- Storage (Local Storage + Cookies - Unchanged) ---
            loadData: () => {
                const local = localStorage.getItem('myBlogAppState');
                if (local) {
                    const savedState = JSON.parse(local);
                    app.state.posts = savedState.posts || [];
                    app.state.blogName = savedState.blogName || 'My Single-File Vanilla Blog';
                    return;
                }
                
                const cookie = app.getCookie('myBlogData');
                if (cookie) {
                    app.state.posts = JSON.parse(cookie);
                }
            },

            saveData: () => {
                const stateToSave = {
                    posts: app.state.posts,
                    blogName: app.state.blogName
                };
                
                const dataStr = JSON.stringify(stateToSave);
                localStorage.setItem('myBlogAppState', dataStr); 

                const postStr = JSON.stringify(app.state.posts);
                document.cookie = `myBlogData=${postStr}; path=/; max-age=31536000; SameSite=Lax`;
            },

            getCookie: (name) => {
                const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                if (match) return match[2];
                return null;
            },

            // --- Blog Name Functions ---
            renderBlogName: () => {
                const blogNameElement = document.getElementById('blog-name');
                const pageTitleElement = document.getElementById('page-title');
                
                blogNameElement.innerText = app.state.blogName;
                pageTitleElement.innerText = app.state.blogName + ' | Single File App';
            },

            setBlogName: () => {
                const newName = document.getElementById('blog-name').innerText.trim();
                
                if (newName && newName !== app.state.blogName) {
                    app.state.blogName = newName;
                    app.saveData(); 
                    app.renderBlogName(); 
                } else if (!newName) {
                    app.renderBlogName(); 
                }
            },
            
            // --- Export/Import Functionality (Unchanged) ---
            exportData: () => {
                const stateToSave = {
                    posts: app.state.posts,
                    blogName: app.state.blogName,
                    exportTime: new Date().toISOString()
                };
                const dataStr = JSON.stringify(stateToSave, null, 2); 

                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');

                link.href = url;
                link.download = `blog_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert("Blog data exported successfully! Check your downloads folder.");
            },

            importData: () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';

                input.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedState = JSON.parse(e.target.result);
                            
                            if (!importedState.posts || !Array.isArray(importedState.posts)) {
                                throw new Error('Invalid file structure. Missing "posts" array.');
                            }

                            app.state.posts = importedState.posts;
                            app.state.blogName = importedState.blogName || 'Imported Single File Blog';
                            
                            app.saveData(); 
                            app.renderBlogName(); 
                            app.navigate('home'); 
                            alert(`Blog data imported successfully! ${app.state.posts.length} posts loaded.`);
                            
                        } catch (error) {
                            alert(`Error importing file: ${error.message}. Make sure the file is a valid blog JSON export.`);
                            console.error('Import Error:', error);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            // --- Navigation, Actions, and Helpers ---
            navigate: (viewId) => {
                document.getElementById('home-view').classList.add('hidden');
                document.getElementById('editor-view').classList.add('hidden');
                document.getElementById('reader-view').classList.add('hidden');
                
                document.getElementById(viewId + '-view').classList.remove('hidden');

                const navBtn = document.getElementById('nav-create-btn');
                navBtn.style.display = (viewId === 'home') ? 'block' : 'none';
                if(viewId === 'home') app.renderList();
            },

            savePost: () => {
                const idInput = document.getElementById('post-id').value;
                const title = document.getElementById('post-title').value;
                const content = document.getElementById('post-content').value;

                if (!title.trim() || !content.trim()) {
                    alert("Please fill in both fields");
                    return;
                }

                const timestamp = new Date().toLocaleString();

                if (idInput) {
                    const index = app.state.posts.findIndex(p => p.id == idInput);
                    if (index !== -1) {
                        app.state.posts[index].title = title;
                        app.state.posts[index].content = content;
                    }
                } else {
                    const newPost = { id: Date.now(), title, content, date: timestamp };
                    app.state.posts.unshift(newPost);
                }

                app.saveData();
                app.clearEditor();
                app.navigate('home');
            },

            cancelEdit: () => { app.clearEditor(); app.navigate('home'); },

            editCurrentPost: () => {
                const post = app.state.posts.find(p => p.id === app.state.activePostId);
                if (!post) return;
                document.getElementById('post-id').value = post.id;
                document.getElementById('post-title').value = post.title;
                document.getElementById('post-content').value = post.content;
                document.getElementById('editor-heading').innerText = "Edit Post";
                app.navigate('editor');
            },

            deleteCurrentPost: () => {
                if (confirm("Are you sure you want to delete this post? This cannot be undone.")) {
                    app.state.posts = app.state.posts.filter(p => p.id !== app.state.activePostId);
                    app.saveData();
                    app.navigate('home');
                }
            },

            viewPost: (id) => {
                const post = app.state.posts.find(p => p.id === app.state.activePostId);
                if (!post) return;
                app.state.activePostId = id;
                document.getElementById('reader-title').innerText = post.title;
                document.getElementById('reader-date').innerText = post.date;
                const htmlContent = marked.parse(post.content); 
                document.getElementById('reader-content').innerHTML = htmlContent;
                app.navigate('reader');
            },

            clearEditor: () => {
                document.getElementById('post-id').value = '';
                document.getElementById('post-title').value = '';
                document.getElementById('post-content').value = '';
                document.getElementById('editor-heading').innerText = "Write New Post";
            },

            renderList: () => {
                const listContainer = document.getElementById('blog-list');
                listContainer.innerHTML = '';

                if (app.state.posts.length === 0) {
                    listContainer.innerHTML = `<div class="text-center py-5 text-muted">
                        <h2>No posts yet üò¢</h2>
                        <p>Click '+ New Post' to start writing.</p>
                    </div>`;
                    return;
                }

                app.state.posts.forEach(post => {
                    const card = document.createElement('div');
                    card.className = 'card post-card mb-3';
                    
                    const snippet = post.content.length > 150 ? post.content.substring(0, 150).replace(/\n/g, ' ') + '...' : post.content.replace(/\n/g, ' ');
                    
                    card.innerHTML = `
                        <div class="card-body">
                            <h3 class="card-title" onclick="app.viewPost(${post.id})">${post.title}</h3>
                            <span class="date">${post.date}</span>
                            <p class="card-text">${snippet}</p>
                            <a href="#" onclick="app.viewPost(${post.id}); return false;" class="btn btn-sm btn-outline-primary">Read More</a>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            }
        };

        // Start the application
        app.init();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>