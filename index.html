<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">My Single-File Vanilla Blog</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
    
    <style>
        /* --- CSS STYLES --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }

        /* Grid Layout for Main Content and Sidebar */
        .content-wrapper {
            display: grid;
            grid-template-columns: 2fr 1fr; /* 2/3 main, 1/3 sidebar */
            gap: 30px;
        }

        /* Sidebar Styles */
        #sidebar-news {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            align-self: start;
        }
        #sidebar-news h3 {
            color: #E91E63;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }
        /* Quote specific styles */
        blockquote {
            font-style: italic; 
            font-size: 1.1em; 
            margin: 0 0 10px 0;
            border-left: 3px solid #E91E63;
            padding-left: 10px;
        }
        /* Navigation & existing styles */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        #blog-name { 
            margin: 0; 
            cursor: pointer; 
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.2s;
            display: inline-block; 
            font-size: 1.5em; 
            font-weight: bold;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.3s;
        }
        .btn-primary { background: #007BFF; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .card h3 { margin-top: 0; color: #007BFF; cursor: pointer; }
        .date { color: #888; font-size: 0.85em; display: block; margin-bottom: 10px; }
        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box; 
            font-family: inherit;
        }
        textarea { height: 300px; resize: vertical; }
        #reader-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            line-height: 1.6;
            margin-top: 20px;
        }
        .hidden { display: none !important; }
        .toolbar { margin-bottom: 15px; }
    </style>
</head>
<body>

    <nav>
        <h1 id="blog-name" contenteditable="true" onblur="app.setBlogName()">‚úçÔ∏è My Single-File Blog</h1>
        <button id="nav-create-btn" class="btn btn-primary" onclick="app.navigate('editor')">+ New Post</button>
    </nav>
    
    <div class="content-wrapper">

        <main>
            <section id="home-view">
                <div style="margin-bottom: 20px;">
                    <p style="color: #6c757d; font-weight: bold; font-size: 0.9em;">
                        ‚ö†Ô∏è Data stored in this browser (Local Storage). <br>
                        ‚ú® **Quote feature requires Node.js proxy running on port 3001.**
                    </p>
                    <button class="btn btn-success" onclick="app.importData()">üì• Import From File</button>
                    <button class="btn btn-secondary" onclick="app.exportData()">üì§ Export To File</button>
                </div>
                <div id="blog-list">
                    </div>
            </section>

            <section id="editor-view" class="hidden">
                <h2 id="editor-heading">Write New Post</h2>
                <p style="color: #6c757d; font-size: 0.9em;">**Markdown formatting is enabled.**</p>
                <input type="hidden" id="post-id">
                <input type="text" id="post-title" placeholder="Enter a catchy title...">
                <textarea id="post-content" placeholder="Write your story here..."></textarea>
                
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="app.savePost()">Save Post</button>
                    <button class="btn btn-secondary" onclick="app.cancelEdit()">Cancel</button>
                </div>
            </section>

            <section id="reader-view" class="hidden">
                <div class="toolbar">
                    <button class="btn btn-secondary" onclick="app.navigate('home')">‚Üê Back to Home</button>
                    <div style="float: right;">
                        <button class="btn btn-warning" onclick="app.editCurrentPost()">Edit</button>
                        <button class="btn btn-danger" onclick="app.deleteCurrentPost()">Delete</button>
                    </div>
                </div>
                <hr style="border: 0; border-top: 1px solid #ddd;">
                
                <h1 id="reader-title" style="font-size: 2.5em; margin-bottom: 5px;"></h1>
                <small id="reader-date" class="date"></small>
                <div id="reader-content"></div>
            </section>
        </main>
        
        <aside id="sidebar-news">
            <h3>üí° Daily Coding Wisdom</h3>
            <div id="news-content">
                <p>Loading quote...</p>
            </div>
        </aside>

    </div> <script>
        const API_ENDPOINT = 'http://localhost:3001/api/quote'; // Proxy URL

        const app = {
            state: {
                posts: [],
                activePostId: null,
                blogName: 'My Single-File Vanilla Blog'
            },
            
            // --- Initialization ---
            init: () => {
                app.loadData();
                app.renderBlogName(); 
                app.renderList();
                app.loadQuoteSidebar(); // Load the quote
            },
            
            // --- Quote Sidebar Function ---
            loadQuoteSidebar: async () => {
                const newsContainer = document.getElementById('news-content');
                newsContainer.innerHTML = '<p>Fetching random quote...</p>'; 

                try {
                    const response = await fetch(API_ENDPOINT);

                    if (response.ok) {
                        const quoteData = await response.json();
                        
                        // Expected JSON structure: { "en": "quote text", "author": "name" }
                        const quoteText = quoteData.en;
                        const author = quoteData.author || "Unknown";
                        
                        if (quoteText) {
                            newsContainer.innerHTML = `
                                <div style="text-align: center; padding: 10px;">
                                    <blockquote>
                                        "${quoteText}"
                                    </blockquote>
                                    <p style="font-weight: bold; color: #E91E63; margin: 0;">‚Äî ${author}</p>
                                </div>
                            `;
                        } else {
                            newsContainer.innerHTML = `<p style="color:red;">Error: Could not retrieve quote text.</p>`;
                        }
                    } else {
                        newsContainer.innerHTML = `<p style="color:red;">Failed to fetch quote (Proxy Status: ${response.status}).</p><p>Ensure your proxy server is running on port 3001.</p>`;
                    }
                } catch (e) {
                    newsContainer.innerHTML = `<p style="color:red;">Could not connect to the proxy server.</p><p>Error: ${e.message}. Ensure Node.js proxy is running.</p>`;
                    console.error("Quote Fetch Error:", e);
                }
            },
            
            // --- Storage (Local Storage + Cookies - Unchanged) ---
            loadData: () => {
                const local = localStorage.getItem('myBlogAppState');
                if (local) {
                    const savedState = JSON.parse(local);
                    app.state.posts = savedState.posts || [];
                    app.state.blogName = savedState.blogName || 'My Single-File Vanilla Blog';
                    return;
                }
                const cookie = app.getCookie('myBlogData');
                if (cookie) {
                    app.state.posts = JSON.parse(cookie);
                }
            },

            saveData: () => {
                const stateToSave = {
                    posts: app.state.posts,
                    blogName: app.state.blogName
                };
                const dataStr = JSON.stringify(stateToSave);
                localStorage.setItem('myBlogAppState', dataStr); 
                const postStr = JSON.stringify(app.state.posts);
                document.cookie = `myBlogData=${postStr}; path=/; max-age=31536000; SameSite=Lax`;
            },

            getCookie: (name) => {
                const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                if (match) return match[2];
                return null;
            },

            // --- Blog Name Functions (Unchanged) ---
            renderBlogName: () => {
                const blogNameElement = document.getElementById('blog-name');
                const pageTitleElement = document.getElementById('page-title');
                blogNameElement.innerText = app.state.blogName;
                pageTitleElement.innerText = app.state.blogName + ' | Single File App';
            },

            setBlogName: () => {
                const newName = document.getElementById('blog-name').innerText.trim();
                if (newName && newName !== app.state.blogName) {
                    app.state.blogName = newName;
                    app.saveData(); 
                    app.renderBlogName(); 
                } else if (!newName) {
                    app.renderBlogName(); 
                }
            },
            
            // --- Export/Import Functionality (Unchanged) ---
            exportData: () => {
                const stateToSave = {
                    posts: app.state.posts,
                    blogName: app.state.blogName,
                    exportTime: new Date().toISOString()
                };
                const dataStr = JSON.stringify(stateToSave, null, 2); 
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');

                link.href = url;
                link.download = `blog_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                alert("Blog data exported successfully!");
            },

            importData: () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';

                input.onchange = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedState = JSON.parse(e.target.result);
                            
                            if (!importedState.posts || !Array.isArray(importedState.posts)) {
                                throw new Error('Invalid file structure. Missing "posts" array.');
                            }

                            app.state.posts = importedState.posts;
                            app.state.blogName = importedState.blogName || 'Imported Single File Blog';
                            
                            app.saveData(); 
                            app.renderBlogName(); 
                            app.navigate('home'); 
                            alert(`Blog data imported successfully! ${app.state.posts.length} posts loaded.`);
                            
                        } catch (error) {
                            alert(`Error importing file: ${error.message}. Make sure the file is a valid blog JSON export.`);
                            console.error('Import Error:', error);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },

            // --- Navigation, Actions, and Helpers (Unchanged) ---
            navigate: (viewId) => {
                document.getElementById('home-view').classList.add('hidden');
                document.getElementById('editor-view').classList.add('hidden');
                document.getElementById('reader-view').classList.add('hidden');
                document.getElementById(viewId + '-view').classList.remove('hidden');

                const navBtn = document.getElementById('nav-create-btn');
                navBtn.style.display = (viewId === 'home') ? 'block' : 'none';
                if(viewId === 'home') app.renderList();
            },

            savePost: () => {
                const idInput = document.getElementById('post-id').value;
                const title = document.getElementById('post-title').value;
                const content = document.getElementById('post-content').value;

                if (!title.trim() || !content.trim()) {
                    alert("Please fill in both fields");
                    return;
                }

                const timestamp = new Date().toLocaleString();

                if (idInput) {
                    const index = app.state.posts.findIndex(p => p.id == idInput);
                    if (index !== -1) {
                        app.state.posts[index].title = title;
                        app.state.posts[index].content = content;
                    }
                } else {
                    const newPost = { id: Date.now(), title, content, date: timestamp };
                    app.state.posts.unshift(newPost);
                }

                app.saveData();
                app.clearEditor();
                app.navigate('home');
            },

            cancelEdit: () => { app.clearEditor(); app.navigate('home'); },

            editCurrentPost: () => {
                const post = app.state.posts.find(p => p.id === app.state.activePostId);
                if (!post) return;
                document.getElementById('post-id').value = post.id;
                document.getElementById('post-title').value = post.title;
                document.getElementById('post-content').value = post.content;
                document.getElementById('editor-heading').innerText = "Edit Post";
                app.navigate('editor');
            },

            deleteCurrentPost: () => {
                if (confirm("Are you sure you want to delete this post? This cannot be undone.")) {
                    app.state.posts = app.state.posts.filter(p => p.id !== app.state.activePostId);
                    app.saveData();
                    app.navigate('home');
                }
            },

            viewPost: (id) => {
                const post = app.state.posts.find(p => p.id === id);
                if (!post) return;
                app.state.activePostId = id;
                document.getElementById('reader-title').innerText = post.title;
                document.getElementById('reader-date').innerText = post.date;
                const htmlContent = marked.parse(post.content); 
                document.getElementById('reader-content').innerHTML = htmlContent;
                app.navigate('reader');
            },

            clearEditor: () => {
                document.getElementById('post-id').value = '';
                document.getElementById('post-title').value = '';
                document.getElementById('post-content').value = '';
                document.getElementById('editor-heading').innerText = "Write New Post";
            },

            renderList: () => {
                const listContainer = document.getElementById('blog-list');
                listContainer.innerHTML = '';

                if (app.state.posts.length === 0) {
                    listContainer.innerHTML = `<div style="text-align:center; color:#777; margin-top:50px;">
                        <h2>No posts yet üò¢</h2>
                        <p>Write one or Import Data.</p>
                    </div>`;
                    return;
                }

                app.state.posts.forEach(post => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    const snippet = post.content.length > 150 ? post.content.substring(0, 150).replace(/\n/g, ' ') + '...' : post.content.replace(/\n/g, ' ');
                    
                    card.innerHTML = `
                        <h3 onclick="app.viewPost(${post.id})">${post.title}</h3>
                        <span class="date">${post.date}</span>
                        <p>${snippet}</p>
                    `;
                    listContainer.appendChild(card);
                });
            }
        };

        // Start the application
        app.init();
    </script>
</body>
</html>